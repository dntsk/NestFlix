# Movie Tracker

Movie Tracker - это веб-приложение на Django для отслеживания просмотренных фильмов, управления личной коллекцией и интеграции с внешними сервисами TMDB и Trakt.tv.

## Функции

- **Личная библиотека фильмов**: Добавление, оценка и отслеживание просмотренных фильмов
- **Публичная библиотека**: Просмотр популярных фильмов по средним оценкам пользователей
- **Поиск фильмов**: Интеграция с TMDB API для поиска и получения информации о фильмах
- **Импорт из Trakt.tv**: Синхронизация данных о просмотренных фильмах и оценках
- **Plex Webhooks**: Автоматическое отслеживание просмотров из Plex Media Server (требует Plex Pass)
- **Управление настройками**: Настройка API ключей для TMDB, Trakt и Plex webhooks
- **Отзывчивый дизайн**: Адаптивный интерфейс с использованием Pico CSS

## Технологии

- **Backend**: Django 5.2
- **Frontend**: HTML, CSS (Pico CSS), JavaScript (HTMX)
- **База данных**: SQLite (по умолчанию)
- **Логирование**: Loguru с ротацией и архивированием
- **Внешние API**:
  - TMDB (The Movie Database)
  - Trakt.tv
- **Дополнительно**: Background tasks для импорта данных

## Установка

### Предварительные требования

- Python 3.8+
- pip
- Git

### Шаги установки

1. **Клонируйте репозиторий:**
   ```bash
   git clone https://github.com/yourusername/movie_tracker.git
   cd movie_tracker
   ```

2. **Создайте виртуальное окружение:**
   ```bash
   python -m venv venv
   source venv/bin/activate  # На Windows: venv\Scripts\activate
   ```

3. **Установите зависимости:**
   ```bash
   pip install -r requirements.txt
   ```

4. **Создайте файл `.env`:**
   ```bash
   cp .env.example .env
   ```
   Отредактируйте `.env` файл с вашими настройками.

4. **Примените миграции:**
   ```bash
   python manage.py migrate
   ```

5. **Создайте суперпользователя:**
   ```bash
   python manage.py createsuperuser
   ```

## Настройка

### API ключи

Для полноценной работы приложения необходимо настроить API ключи:

1. **TMDB API Key**:
   - Зарегистрируйтесь на [TMDB](https://www.themoviedb.org/)
   - Получите API ключ в настройках аккаунта
   - В приложении перейдите в "Настройки" и введите TMDB API Key

2. **Trakt.tv API**:
   - Зарегистрируйтесь на [Trakt.tv](https://trakt.tv/)
   - Перейдите в [Applications](https://trakt.tv/oauth/applications) и создайте новое приложение
   - Заполните необходимые поля (Name, Description, Redirect uri можно указать `urn:ietf:wg:oauth:2.0:oob`)
   - Получите **Client ID** (обязательно) и **Client Secret** (опционально)
   - В приложении перейдите в "Настройки" и введите:
     - **Trakt.tv Username** - ваш username на Trakt.tv
     - **Trakt.tv Client ID** - Client ID вашего приложения

### Переменные окружения

Создайте файл `.env` в корне проекта:

```env
SECRET_KEY=your_django_secret_key_here
DEBUG=True
ALLOWED_HOSTS=localhost,127.0.0.1
```

**Примечание**: API ключи для TMDB и Trakt.tv настраиваются через пользовательский интерфейс в разделе "Настройки" и хранятся в базе данных.

## Запуск

1. **Активируйте виртуальное окружение:**
   ```bash
   source venv/bin/activate
   ```

2. **Запустите сервер разработки:**
   ```bash
   python manage.py runserver
   ```

3. **Откройте браузер и перейдите по адресу:**
   ```
   http://localhost:8000
   ```

## Использование

### Для новых пользователей

1. Зарегистрируйтесь или войдите в систему
2. Настройте TMDB API Key в разделе "Настройки"
3. Начните поиск и добавление фильмов

### Основные возможности

- **Главная страница**: Просмотр популярных фильмов (для неавторизованных) или личной библиотеки (для авторизованных)
- **Поиск фильмов**: Используйте поисковую строку для нахождения фильмов
- **Добавление фильма**: Нажмите на фильм в результатах поиска для добавления в коллекцию
- **Оценка фильмов**: Ставьте оценки и отмечайте просмотренные фильмы
- **Импорт из Trakt**: Синхронизируйте данные из Trakt.tv аккаунта

### Импорт из Trakt.tv

1. Настройте Trakt API в разделе "Настройки":
   - Введите ваш Trakt.tv username
   - Введите Client ID вашего Trakt приложения
2. Перейдите в раздел "Настройки" (импорт доступен после настройки API)
3. Нажмите "Импортировать из Trakt.tv"
4. Система автоматически импортирует:
   - Просмотренные фильмы
   - Оценки фильмов и сериалов
   - Историю просмотров

**Примечание**: Импорт выполняется в фоновом режиме. Одна активная задача импорта на пользователя.

### Plex Webhooks (требует Plex Pass)

1. Перейдите в раздел "Настройки"
2. В секции "Plex Webhook" нажмите "Сгенерировать Webhook"
3. Скопируйте сгенерированный URL
4. Откройте [настройки Plex Webhooks](https://app.plex.tv/desktop/#!/account/webhooks)
5. Добавьте скопированный URL
6. Готово! Теперь просмотренные фильмы будут автоматически добавляться в вашу библиотеку

**Поддерживаемые события:**
- `media.scrobble` - фильм/сериал досмотрен (> 90%)
- `media.play` - начало воспроизведения (добавление в коллекцию)

**Безопасность:** Каждый пользователь имеет уникальный токен. Можно перегенерировать или отключить в любой момент.

## Структура проекта

```
movie_tracker/
├── catalog/                 # Основное приложение
│   ├── migrations/         # Миграции базы данных
│   ├── templates/          # Шаблоны HTML
│   │   └── catalog/
│   ├── static/             # Статические файлы
│   ├── models.py           # Модели данных
│   ├── views.py            # Представления
│   ├── urls.py             # URL маршруты
│   ├── tmdb_client.py      # Клиент TMDB API
│   ├── trakt_client.py     # Клиент Trakt API
│   └── tasks.py            # Фоновые задачи
├── movie_tracker/          # Настройки проекта
│   ├── settings.py         # Основные настройки
│   ├── urls.py             # Корневые URL
│   └── wsgi.py             # WSGI конфигурация
├── media/                  # Медиа файлы (загружаемые пользователями)
├── staticfiles/            # Собранные статические файлы
├── db.sqlite3              # База данных
├── manage.py               # Скрипт управления Django
├── requirements.txt        # Зависимости Python
└── README.md               # Этот файл
```

## Модели данных

- **Movie**: Информация о фильме (TMDB ID, данные из API)
- **UserRating**: Оценки пользователей, статус просмотра
- **UserSettings**: Настройки пользователя (API ключи)
- **ImportTask**: Задачи импорта из Trakt.tv

## API интеграции

### TMDB API
- Поиск фильмов
- Получение детальной информации о фильмах
- Постеры и изображения

### Trakt.tv API
- **Тип аутентификации**: Client ID (без OAuth)
- **Данные для импорта**:
  - Просмотренные фильмы
  - Оценки фильмов и сериалов  
  - История просмотров
- **Особенности**: Импорт через публичный API без необходимости полной OAuth аутентификации

## Разработка

### Добавление новых функций

1. Создайте новую ветку для разработки
2. Реализуйте функцию
3. Напишите тесты
4. Создайте pull request

### Стиль кода

- Следуйте PEP 8 для Python кода
- Используйте осмысленные названия переменных и функций
- Добавляйте комментарии к сложным участкам кода

## Развертывание

### Production настройки

1. Установите `DEBUG=False` в settings.py
2. Настройте статические файлы:
   ```bash
   python manage.py collectstatic
   ```
3. Используйте production-ready веб-сервер (Gunicorn, uWSGI)
4. Настройте базу данных (PostgreSQL рекомендуется для production)

### Docker

Для развертывания с Docker:

```dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

RUN python manage.py collectstatic --noinput

EXPOSE 8000

CMD ["gunicorn", "movie_tracker.wsgi:application", "--bind", "0.0.0.0:8000"]
```

## Логирование

Проект использует **Loguru** для структурированного логирования:

- **Файлы логов**:
  - `logs/movie_tracker.log` - все сообщения (DEBUG и выше), ротация 10 МБ, хранение 30 дней
  - `logs/errors.log` - только ошибки (ERROR и выше), ротация 10 МБ, хранение 60 дней

- **Уровни логирования**:
  - `DEBUG` - детальная отладочная информация
  - `INFO` - информационные сообщения о работе приложения
  - `ERROR` - сообщения об ошибках

- **Безопасность**: API ключи и другие чувствительные данные автоматически маскируются в логах

## Тестирование

```bash
python manage.py test
```

## Вклад в проект

1. Fork репозиторий
2. Создайте feature branch
3. Commit изменения
4. Push в branch
5. Создайте Pull Request

## Лицензия

Этот проект лицензирован под MIT License - см. файл LICENSE для деталей.

## Поддержка

Если у вас возникли проблемы или вопросы:

1. Проверьте раздел Troubleshooting в документации
2. Создайте issue на GitHub
3. Свяжитесь с разработчиками

## Changelog

### v1.0.0
- Первая стабильная версия
- Базовая функциональность трекинга фильмов
- Интеграция с TMDB и Trakt.tv
- Отзывчивый веб-интерфейс