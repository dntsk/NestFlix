{% extends 'catalog/base.html' %}
{% load i18n %}

{% block title %}{% trans "Settings" %}{% endblock %}

{% block content %}
<style>
input[type="text"] {
    height: 2rem;
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}
select {
    height: 2rem;
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}
button {
    background-color: var(--primary) !important;
    color: #ffffff !important;
    border: none !important;
    padding: 0.5rem 1rem !important;
    font-size: 0.75rem !important;
    border-radius: 4px !important;
    width: 250px !important;
}
</style>
<h1>{% trans "Settings" %}</h1>
<p>{% trans "Configure your personal settings and API keys." %}</p>

<form method="post">
    {% csrf_token %}

    <h2>{% trans "Interface" %}</h2>
    
    <label for="language">{% trans "Language" %}:</label>
    <select id="language" name="language">
        <option value="en" {% if settings.language == 'en' %}selected{% endif %}>English</option>
        <option value="ru" {% if settings.language == 'ru' %}selected{% endif %}>–†—É—Å—Å–∫–∏–π</option>
    </select>
    <small>{% trans "Select your preferred interface language" %}</small>

    <h2 style="margin-top: 2rem;">{% trans "API Settings" %}</h2>
    <p>{% trans "Configure API keys to connect to external services." %}</p>

    <label for="tmdb_api_key">{% trans "TMDB API Key" %}:</label>
    <input type="text" id="tmdb_api_key" name="tmdb_api_key" value="{{ settings.tmdb_api_key }}" placeholder="{% trans 'Enter your TMDB API Key' %}" required>
    <small>{% trans "Get your key at" %} <a href="https://www.themoviedb.org/settings/api" target="_blank">themoviedb.org</a></small>

    <label for="trakt_username">{% trans "Trakt.tv Username" %}:</label>
    <input type="text" id="trakt_username" name="trakt_username" value="{{ settings.trakt_username }}" placeholder="{% trans 'Your username on Trakt.tv' %}">

    <label for="trakt_client_id">{% trans "Trakt.tv Client ID" %}:</label>
    <input type="text" id="trakt_client_id" name="trakt_client_id" value="{{ settings.trakt_client_id }}" placeholder="{% trans 'Your application Client ID' %}">
    <small>{% trans "Create an application at" %} <a href="https://trakt.tv/oauth/applications" target="_blank">trakt.tv</a></small>

    <button type="submit" style="float: right;">{% trans "Save Settings" %}</button>
</form>
<div style="clear: both;"></div>

<!-- Plex Webhook Section -->
<h2>Plex Webhook</h2>
<p>Automatically add watched movies from Plex in real-time</p>

{% if settings.plex_webhook_token and settings.plex_webhook_enabled %}
    <div style="background: var(--card-background-color, #f8f9fa); padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid var(--card-border-color, #e9ecef);">
        <p><strong>Webhook URL:</strong></p>
        <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
            <input type="text" id="webhook-url" readonly 
                   value="{{ request.scheme }}://{{ request.get_host }}{% url 'catalog:plex_webhook' token=settings.plex_webhook_token %}"
                   style="flex: 1; font-size: 0.875rem;">
            <button type="button" onclick="copyWebhookUrl()" style="width: auto !important; padding: 0.5rem 1rem !important;">
                üìã Copy
            </button>
        </div>
        <small>Add this URL to <a href="https://app.plex.tv/desktop/#!/account/webhooks" target="_blank">Plex Webhooks settings</a></small>
        
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--card-border-color, #e9ecef);">
            <p><small>Created: {{ settings.plex_webhook_created_at|date:"Y-m-d H:i" }}</small></p>
            <button type="button" onclick="regenerateWebhook()" style="width: auto !important; background: var(--secondary) !important; margin-right: 0.5rem;">
                üîÑ Regenerate
            </button>
            <button type="button" onclick="disableWebhook()" style="width: auto !important; background: #dc3545 !important;">
                ‚ùå Disable
            </button>
        </div>
    </div>
{% else %}
    <p>Webhook not configured. Click the button below to generate a unique URL.</p>
    <button type="button" onclick="generateWebhook()" style="width: auto !important;">
        ‚ú® Generate Webhook
    </button>
    <div id="webhook-status" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--card-background-color, #f8f9fa); border-radius: 8px;">
        <p id="webhook-message"></p>
    </div>
{% endif %}

<script>
function getCsrfToken() {
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfInput) {
        return csrfInput.value;
    }
    
    const csrfCookie = document.cookie.split('; ')
        .find(row => row.startsWith('csrftoken='));
    if (csrfCookie) {
        return csrfCookie.split('=')[1];
    }
    
    return '{{ csrf_token }}';
}

function generateWebhook() {
    const csrfToken = getCsrfToken();
    console.log('Generating webhook with CSRF token:', csrfToken ? 'present' : 'missing');
    
    fetch('{% url "catalog:generate_plex_webhook" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(r => {
        console.log('Response status:', r.status);
        if (!r.ok) {
            throw new Error(`HTTP ${r.status}`);
        }
        return r.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            location.reload();
        } else {
            alert('Webhook generation error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    });
}

function regenerateWebhook() {
    if (!confirm('The old URL will stop working. Continue?')) return;
    generateWebhook();
}

function disableWebhook() {
    if (!confirm('Disable Plex webhook?')) return;
    
    fetch('{% url "catalog:disable_plex_webhook" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(r => {
        if (!r.ok) {
            throw new Error(`HTTP ${r.status}`);
        }
        return r.json();
    })
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

function copyWebhookUrl() {
    const input = document.getElementById('webhook-url');
    input.select();
    input.setSelectionRange(0, 99999);
    
    try {
        document.execCommand('copy');
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '‚úÖ Copied!';
        button.style.background = '#28a745';
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.style.background = '';
        }, 2000);
    } catch (err) {
        alert('Failed to copy. Please copy manually.');
    }
}
</script>

<hr style="margin: 2rem 0;">

{% if settings.tmdb_api_key and settings.trakt_username and settings.trakt_client_id %}
<h2>Import from Trakt</h2>
<p>Import watched movies and ratings from Trakt.tv</p>

<!-- Import indicator -->
<div id="import-status" style="display: none; margin: 1rem 0; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; background-color: var(--secondary);">
    <div style="display: flex; align-items: center; gap: 0.5rem;">
        <div class="spinner" style="width: 16px; height: 16px; border: 2px solid var(--muted); border-top: 2px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <span id="status-text" style="color: var(--text); font-weight: 500;">Import in progress...</span>
    </div>
</div>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<form method="post" action="{% url 'catalog:import_trakt' %}">
    {% csrf_token %}
    <button type="submit" id="import-btn" style="float: right;">Import from Trakt.tv</button>
</form>
<div style="clear: both;"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const importBtn = document.getElementById('import-btn');
    const statusDiv = document.getElementById('import-status');
    const statusText = document.getElementById('status-text');

    let currentTaskId = null;
    let statusCheck = null;

    function checkStatus() {
        if (!currentTaskId) return;

        console.log('Checking status for task:', currentTaskId);

        fetch(`/import-status/${currentTaskId}/`)
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Received data:', data);

                if (data.error) {
                    console.log('Error in data:', data.error);
                    clearInterval(statusCheck);
                    hideImportStatus();
                    return;
                }

                statusDiv.style.display = 'block';

                switch(data.status) {
                    case 'pending':
                        statusText.textContent = 'Import is being processed...';
                        break;
                    case 'running':
                        console.log('Running status - imported:', data.imported_count, 'total:', data.total_items);
                        if (data.imported_count !== undefined && data.total_items !== undefined) {
                            statusText.textContent = `Import in progress: ${data.imported_count}/${data.total_items} movies`;
                        } else {
                            statusText.textContent = 'Import in progress...';
                        }
                        break;
                    case 'completed':
                        statusText.textContent = 'Import completed!';
                        importBtn.disabled = false;
                        importBtn.textContent = 'Import from Trakt.tv';
                        clearInterval(statusCheck);
                        localStorage.removeItem('active_import_task');
                        setTimeout(() => {
                            statusDiv.style.display = 'none';
                        }, 3000);
                        break;
                    case 'failed':
                        statusText.textContent = 'Import failed';
                        importBtn.disabled = false;
                        importBtn.textContent = 'Import from Trakt.tv';
                        clearInterval(statusCheck);
                        localStorage.removeItem('active_import_task');
                        setTimeout(() => {
                            statusDiv.style.display = 'none';
                        }, 5000);
                        break;
                }
            })
            .catch(error => {
                console.error('Error checking status:', error);
                clearInterval(statusCheck);
                hideImportStatus();
            });
    }

    function hideImportStatus() {
        statusDiv.style.display = 'none';
        localStorage.removeItem('active_import_task');
    }

    document.querySelector('form[action*="import-trakt"]').addEventListener('submit', function(e) {
        e.preventDefault();
        importBtn.disabled = true;
        importBtn.textContent = 'Starting...';

        fetch('/import-trakt/', {
            method: 'POST',
            body: new FormData(this),
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                importBtn.disabled = false;
                importBtn.textContent = 'Import from Trakt.tv';
                return;
            }

            currentTaskId = data.task_id;
            localStorage.setItem('active_import_task', currentTaskId);

            window.dispatchEvent(new CustomEvent('importStarted', {
                detail: { taskId: currentTaskId }
            }));

            statusDiv.style.display = 'block';
            statusCheck = setInterval(checkStatus, 3000);
        })
        .catch(error => {
            console.error('Error starting import:', error);
            alert('Error starting import');
            importBtn.disabled = false;
            importBtn.textContent = 'Import from Trakt.tv';
        });
    });

    const savedTaskId = localStorage.getItem('active_import_task');
    if (savedTaskId) {
        currentTaskId = savedTaskId;
        statusDiv.style.display = 'block';
        statusCheck = setInterval(checkStatus, 3000);
    }
});
</script>
{% endif %}
{% endblock %}
