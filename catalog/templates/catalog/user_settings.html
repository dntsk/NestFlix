{% extends 'catalog/base.html' %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏{% endblock %}

{% block content %}
<style>
input[type="text"] {
    height: 2rem;
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}
button {
    background-color: var(--primary) !important;
    color: #ffffff !important;
    border: none !important;
    padding: 0.5rem 1rem !important;
    font-size: 0.75rem !important;
    border-radius: 4px !important;
    width: 250px !important;
}
</style>
<h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ API</h1>
<p>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–ª—é—á–∏ API –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –≤–Ω–µ—à–Ω–∏–º —Å–µ—Ä–≤–∏—Å–∞–º.</p>

<form method="post">
    {% csrf_token %}

    <label for="tmdb_api_key">TMDB API Key:</label>
    <input type="text" id="tmdb_api_key" name="tmdb_api_key" value="{{ settings.tmdb_api_key }}" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à TMDB API Key" required>
    <small>–ü–æ–ª—É—á–∏—Ç–µ –∫–ª—é—á –Ω–∞ <a href="https://www.themoviedb.org/settings/api" target="_blank">themoviedb.org</a></small>

    <label for="trakt_username">Trakt.tv Username:</label>
    <input type="text" id="trakt_username" name="trakt_username" value="{{ settings.trakt_username }}" placeholder="–í–∞—à username –Ω–∞ Trakt.tv">

    <label for="trakt_client_id">Trakt.tv Client ID:</label>
    <input type="text" id="trakt_client_id" name="trakt_client_id" value="{{ settings.trakt_client_id }}" placeholder="Client ID –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è">
    <small>–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ <a href="https://trakt.tv/oauth/applications" target="_blank">trakt.tv</a></small>

    <button type="submit" style="float: right;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</form>
<div style="clear: both;"></div>

<!-- Plex Webhook Section -->
<h2>Plex Webhook</h2>
<p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å–º—ã –∏–∑ Plex –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>

{% if settings.plex_webhook_token and settings.plex_webhook_enabled %}
    <div style="background: var(--card-background-color, #f8f9fa); padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid var(--card-border-color, #e9ecef);">
        <p><strong>Webhook URL:</strong></p>
        <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
            <input type="text" id="webhook-url" readonly 
                   value="{{ request.scheme }}://{{ request.get_host }}{% url 'catalog:plex_webhook' token=settings.plex_webhook_token %}"
                   style="flex: 1; font-size: 0.875rem;">
            <button type="button" onclick="copyWebhookUrl()" style="width: auto !important; padding: 0.5rem 1rem !important;">
                üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
            </button>
        </div>
        <small>–î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç URL –≤ <a href="https://app.plex.tv/desktop/#!/account/webhooks" target="_blank">–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Plex Webhooks</a></small>
        
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--card-border-color, #e9ecef);">
            <p><small>–°–æ–∑–¥–∞–Ω: {{ settings.plex_webhook_created_at|date:"d.m.Y H:i" }}</small></p>
            <button type="button" onclick="regenerateWebhook()" style="width: auto !important; background: var(--secondary) !important; margin-right: 0.5rem;">
                üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
            </button>
            <button type="button" onclick="disableWebhook()" style="width: auto !important; background: #dc3545 !important;">
                ‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å
            </button>
        </div>
    </div>
{% else %}
    <p>Webhook –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ URL.</p>
    <button type="button" onclick="generateWebhook()" style="width: auto !important;">
        ‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Webhook
    </button>
    <div id="webhook-status" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--card-background-color, #f8f9fa); border-radius: 8px;">
        <p id="webhook-message"></p>
    </div>
{% endif %}

<script>
function getCsrfToken() {
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfInput) {
        return csrfInput.value;
    }
    
    const csrfCookie = document.cookie.split('; ')
        .find(row => row.startsWith('csrftoken='));
    if (csrfCookie) {
        return csrfCookie.split('=')[1];
    }
    
    return '{{ csrf_token }}';
}

function generateWebhook() {
    const csrfToken = getCsrfToken();
    console.log('Generating webhook with CSRF token:', csrfToken ? 'present' : 'missing');
    
    fetch('{% url "catalog:generate_plex_webhook" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(r => {
        console.log('Response status:', r.status);
        if (!r.ok) {
            throw new Error(`HTTP ${r.status}`);
        }
        return r.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ webhook: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    });
}

function regenerateWebhook() {
    if (!confirm('–°—Ç–∞—Ä—ã–π URL –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) return;
    generateWebhook();
}

function disableWebhook() {
    if (!confirm('–û—Ç–∫–ª—é—á–∏—Ç—å Plex webhook?')) return;
    
    fetch('{% url "catalog:disable_plex_webhook" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(r => {
        if (!r.ok) {
            throw new Error(`HTTP ${r.status}`);
        }
        return r.json();
    })
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    });
}

function copyWebhookUrl() {
    const input = document.getElementById('webhook-url');
    input.select();
    input.setSelectionRange(0, 99999);
    
    try {
        document.execCommand('copy');
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        button.style.background = '#28a745';
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.style.background = '';
        }, 2000);
    } catch (err) {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.');
    }
}
</script>

<hr style="margin: 2rem 0;">

{% if settings.tmdb_api_key and settings.trakt_username and settings.trakt_client_id %}
<h2>–ò–º–ø–æ—Ä—Ç –∏–∑ Trakt</h2>
<p>–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å–º—ã –∏ –æ—Ü–µ–Ω–∫–∏ –∏–∑ Trakt.tv</p>

<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∏–º–ø–æ—Ä—Ç–∞ -->
<div id="import-status" style="display: none; margin: 1rem 0; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; background-color: var(--secondary);">
    <div style="display: flex; align-items: center; gap: 0.5rem;">
        <div class="spinner" style="width: 16px; height: 16px; border: 2px solid var(--muted); border-top: 2px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <span id="status-text" style="color: var(--text); font-weight: 500;">–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...</span>
    </div>
</div>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<form method="post" action="{% url 'catalog:import_trakt' %}">
    {% csrf_token %}
    <button type="submit" id="import-btn" style="float: right;">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ Trakt.tv</button>
</form>
<div style="clear: both;"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const importBtn = document.getElementById('import-btn');
    const statusDiv = document.getElementById('import-status');
    const statusText = document.getElementById('status-text');

    let currentTaskId = null;
    let statusCheck = null;

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
    function checkStatus() {
        if (!currentTaskId) return;

        console.log('Checking status for task:', currentTaskId);

        fetch(`/import-status/${currentTaskId}/`)
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Received data:', data);

                if (data.error) {
                    console.log('Error in data:', data.error);
                    clearInterval(statusCheck);
                    hideImportStatus();
                    return;
                }

                statusDiv.style.display = 'block';

                switch(data.status) {
                    case 'pending':
                        statusText.textContent = '–ò–º–ø–æ—Ä—Ç –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è...';
                        break;
                    case 'running':
                        console.log('Running status - imported:', data.imported_count, 'total:', data.total_items);
                        if (data.imported_count !== undefined && data.total_items !== undefined) {
                            statusText.textContent = `–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è: ${data.imported_count}/${data.total_items} —Ñ–∏–ª—å–º–æ–≤`;
                        } else {
                            statusText.textContent = '–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
                        }
                        break;
                    case 'completed':
                        statusText.textContent = '–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!';
                        importBtn.disabled = false;
                        importBtn.textContent = '–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ Trakt.tv';
                        clearInterval(statusCheck);
                        localStorage.removeItem('active_import_task');
                        setTimeout(() => {
                            statusDiv.style.display = 'none';
                        }, 3000);
                        break;
                    case 'failed':
                        statusText.textContent = '–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞';
                        importBtn.disabled = false;
                        importBtn.textContent = '–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ Trakt.tv';
                        clearInterval(statusCheck);
                        localStorage.removeItem('active_import_task');
                        setTimeout(() => {
                            statusDiv.style.display = 'none';
                        }, 5000);
                        break;
                }
            })
            .catch(error => {
                console.error('Error checking status:', error);
                clearInterval(statusCheck);
                hideImportStatus();
            });
    }

    function hideImportStatus() {
        statusDiv.style.display = 'none';
        localStorage.removeItem('active_import_task');
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
    document.querySelector('form[action*="import-trakt"]').addEventListener('submit', function(e) {
        e.preventDefault();
        importBtn.disabled = true;
        importBtn.textContent = '–ó–∞–ø—É—Å–∫...';

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX –∑–∞–ø—Ä–æ—Å
        fetch('/import-trakt/', {
            method: 'POST',
            body: new FormData(this),
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                importBtn.disabled = false;
                importBtn.textContent = '–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ Trakt.tv';
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π task_id –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
            currentTaskId = data.task_id;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–∞ –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö
            localStorage.setItem('active_import_task', currentTaskId);

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
            window.dispatchEvent(new CustomEvent('importStarted', {
                detail: { taskId: currentTaskId }
            }));

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∏ –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
            statusDiv.style.display = 'block';
            statusCheck = setInterval(checkStatus, 3000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
        })
        .catch(error => {
            console.error('Error starting import:', error);
            alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∏–º–ø–æ—Ä—Ç–∞');
            importBtn.disabled = false;
            importBtn.textContent = '–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ Trakt.tv';
        });
    });

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π –∏–º–ø–æ—Ä—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const savedTaskId = localStorage.getItem('active_import_task');
    if (savedTaskId) {
        currentTaskId = savedTaskId;
        statusDiv.style.display = 'block';
        statusCheck = setInterval(checkStatus, 3000);
    }
});
</script>
{% endif %}
{% endblock %}