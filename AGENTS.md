# AGENTS.md - Руководство по кодовой базе Movie Tracker

## Команды сборки/тестирования
- `make server` - Запуск Django сервера разработки
- `make worker` - Запуск воркера фоновых задач
- `make migrate` - Применение миграций базы данных
- `python manage.py test` - Запуск всех тестов
- `python manage.py test catalog.tests` - Запуск тестов приложения catalog
- `python manage.py test catalog.tests.ClassName` - Запуск конкретного класса тестов
- `python manage.py test catalog.tests.ClassName.test_method` - Запуск одного теста

## Правила стиля кода
- **Импорты**: Сначала стандартные Django импорты, затем сторонние, затем локальные приложения
- **Форматирование**: 4-пробельных отступа, максимальная длина строки 79 символов
- **Именование**: snake_case для переменных/функций, PascalCase для классов
- **Обработка ошибок**: Использовать try/except с конкретными исключениями
- **Модели**: Использовать verbose_name и help_text для полей
- **Представления**: Использовать декоратор @login_required для views требующих авторизации
- **Шаблоны**: Использовать язык шаблонов Django с правильным наследованием
- **Типизация**: В настоящее время не используется, следовать существующим шаблонам

## Тестирование
- Писать тесты в catalog/tests.py следуя паттернам Django TestCase
- Использовать осмысленные имена методов тестов начинающиеся с "test_"
- Тестировать как успешные сценарии, так и случаи ошибок
- Мокировать вызовы внешних API в тестах

## Логирование
- **Библиотека**: loguru (вместо print)
- **Конфигурация**: catalog/logger.py
- **Файлы логов**:
  - logs/movie_tracker.log (уровень DEBUG, ротация 10 МБ, хранение 30 дней)
  - logs/errors.log (уровень ERROR, ротация 10 МБ, хранение 60 дней)
- **Импорт**: `from .logger import logger, mask_sensitive`
- **Использование**:
  ```python
  logger.info("Информационное сообщение")
  logger.debug("Отладочная информация")
  logger.error("Сообщение об ошибке")
  logger.warning("Предупреждение")
  
  # Маскировка чувствительных данных
  logger.info(f"API key: {mask_sensitive(api_key)}")
  ```

## Plex Webhook Integration
- **Endpoint**: `/webhook/plex/<token>/` (CSRF exempt)
- **Генерация токена**: `/settings/generate-plex-webhook/` (POST)
- **Отключение**: `/settings/disable-plex-webhook/` (POST)
- **Модели**:
  - `UserSettings`: поля `plex_webhook_token`, `plex_webhook_enabled`, `plex_webhook_created_at`
  - `PlexWebhookEvent`: логирование всех webhook событий для аудита
- **Обработка**: `catalog/plex_utils.py`
  - `extract_tmdb_id_from_plex_guid()` - парсинг TMDB ID из Plex GUID
  - `process_plex_event()` - обработка событий (media.play, media.scrobble)
  - `log_webhook_event()` - сохранение событий в БД
- **Безопасность**:
  - Уникальный UUID токен для каждого пользователя
  - Логирование всех запросов
  - Возможность отключения/перегенерации
  - Маскировка токенов в логах

## Правила безопасного кода
- **Защита чувствительных данных**: API ключи и Client ID должны маскироваться в логах (первые 4 и последние 4 символа)
- **Логирование**: 
  - Использовать loguru для всех сообщений
  - Никогда не логировать полные API ключи, пароли или токены
  - Использовать функцию mask_sensitive() из catalog.logger для маскировки
  - Уровни: DEBUG для отладки, INFO для информации, ERROR для ошибок
- **Админка**: В интерфейсе администратора отображать только маскированные версии чувствительных данных
- **Валидация**: Проверять длину и формат API ключей (TMDB: 32 символа, Trakt: 64 символа)
- **CSRF защита**: Все формы должны содержать {% csrf_token %}
- **Rate limiting**: Ограничивать частоту запросов для предотвращения злоупотреблений
- **Обработка ошибок**: Не раскрывать детали внутренних ошибок в ответах API
- **Хранение данных**: Чувствительные данные должны храниться в зашифрованном виде в базе данных